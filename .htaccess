# Comprehensive .htaccess for Jay's Mobile Wash
# Fixes path issues and optimizes for SEO, security, and performance

# Enable rewrite engine for URL manipulation
RewriteEngine On

# Force HTTPS
RewriteCond %{HTTPS} !=on
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# WWW to non-WWW redirect
RewriteCond %{HTTP_HOST} ^www\.jaysmobilewash\.net [NC]
RewriteRule ^(.*)$ https://jaysmobilewash.net/$1 [L,R=301]

# === PATH CORRECTION FOR FLAT DIRECTORY STRUCTURE ===

# Redirect /js/ folder requests to root directory files
RewriteCond %{REQUEST_URI} ^/js/(.*)\.js$
RewriteRule ^js/(.*)\.js$ $1.js [L]

# Redirect /css/ folder requests to root directory files  
RewriteCond %{REQUEST_URI} ^/css/(.*)\.css$
RewriteRule ^css/(.*)\.css$ $1.css [L]

# Redirect /images/ folder requests to root directory images
RewriteCond %{REQUEST_URI} ^/images/(.*)$
RewriteRule ^images/(.*)$ $1 [L]

# === PERFORMANCE OPTIMIZATION ===

# Enable GZIP compression
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE image/svg+xml
  AddOutputFilterByType DEFLATE font/ttf
  AddOutputFilterByType DEFLATE font/otf
  AddOutputFilterByType DEFLATE font/eot
  AddOutputFilterByType DEFLATE font/woff
  AddOutputFilterByType DEFLATE font/woff2
</IfModule>

# Browser caching
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/pdf "access plus 1 month"
  ExpiresByType text/javascript "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresByType application/x-javascript "access plus 1 month"
  ExpiresByType application/x-shockwave-flash "access plus 1 month"
  ExpiresByType image/x-icon "access plus 1 year"
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/otf "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresDefault "access plus 2 days"
</IfModule>

# === SECURITY HEADERS ===

<IfModule mod_headers.c>
  # XSS Protection
  Header set X-XSS-Protection "1; mode=block"
  
  # Prevent MIME-type sniffing
  Header set X-Content-Type-Options "nosniff"
  
  # Referrer policy
  Header set Referrer-Policy "no-referrer-when-downgrade"
  
  # Content Security Policy - Commented out, uncomment and customize as needed
  # Header set Content-Security-Policy "default-src 'self'; script-src 'self' https://www.googletagmanager.com https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com https://cdnjs.cloudflare.com 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:;"
  
  # CORS Headers
  <FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|font.css|css|js|json|jpg|jpeg|png|gif|svg)$">
    Header set Access-Control-Allow-Origin "*"
  </FilesMatch>
  
  # Cache Control for static assets
  <FilesMatch "\.(ico|pdf|flv|jpg|jpeg|png|gif|webp|svg|js|css|swf|ttf|otf|woff|woff2)$">
    Header set Cache-Control "max-age=31536000, public"
  </FilesMatch>
  
  # Cache Control for HTML and XML files
  <FilesMatch "\.(html|htm|xml)$">
    Header set Cache-Control "max-age=7200, must-revalidate"
  </FilesMatch>
</IfModule>

# === ADDITIONAL SECURITY SETTINGS ===

# Prevent directory listing
Options -Indexes

# Block access to hidden files and directories
<IfModule mod_rewrite.c>
  RewriteCond %{SCRIPT_FILENAME} -d [OR]
  RewriteCond %{SCRIPT_FILENAME} -f
  RewriteRule "(^|/)\." - [F]
</IfModule>

# Block access to backup and source files
<FilesMatch "(\.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)|~)$">
  Order allow,deny
  Deny from all
  Satisfy All
</FilesMatch>

# === CUSTOM ERROR PAGES ===

# Custom error documents
ErrorDocument 400 /error.html
ErrorDocument 401 /error.html
ErrorDocument 403 /error.html
ErrorDocument 404 /error.html
ErrorDocument 500 /error.html

# === SEO OPTIMIZATIONS ===

# Canonical redirects
# Redirect index.html to root
RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s/+index\.html [NC]
RewriteRule ^ / [R=301,L]

# Redirect trailing slashes
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ /$1 [L,R=301]

# Add trailing slash to directories
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^(.*[^/])$ /$1/ [L,R=301]

# === 404 HANDLING ===

# Try to route missing page requests to HTML files
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.html -f
RewriteRule ^(.*)$ $1.html [L]

# === PHP SETTINGS (if applicable) ===

# Adjust PHP settings if needed
#<IfModule mod_php7.c>
#  php_value upload_max_filesize 16M
#  php_value post_max_size 16M
#  php_value max_execution_time 300
#  php_value max_input_time 300
#</IfModule>

# === UTF-8 ENCODING ===

# Serve resources with the proper encoding
AddDefaultCharset UTF-8
AddCharset UTF-8 .css
AddCharset UTF-8 .js
AddCharset UTF-8 .json
AddCharset UTF-8 .html
AddCharset UTF-8 .xml
